document.addEventListener("DOMContentLoaded", () => {
  const materias = document.querySelectorAll(".materia");

  // Carga el estado guardado o inicializa vacío
  let estado = JSON.parse(localStorage.getItem("estadoMaterias")) || {};

  // Inicializa materias
  materias.forEach(materia => {
    const id = materia.dataset.id;

    // Si no hay estado guardado para esta materia, inicializa como false (no aprobada)
    if (estado[id] === undefined) {
      estado[id] = false;
    }

    // Aplica clases según estado guardado
    materia.classList.toggle("aprobada", estado[id]);
  });

  // Función que verifica si se cumplen los requisitos para desbloquear una materia
  function requisitosCumplidos(materia) {
    const req = materia.dataset.requisitos;
    if (!req) return true;

    const requisitos = req.split(",").map(r => r.trim());
    return requisitos.every(rid => estado[rid]);
  }

  // Actualiza el bloqueo/desbloqueo de materias según requisitos y estado
  function actualizarBloqueos() {
    materias.forEach(materia => {
      if (requisitosCumplidos(materia)) {
        materia.classList.remove("bloqueada");
      } else {
        if (!estado[materia.dataset.id]) {
          materia.classList.add("bloqueada");
          materia.classList.remove("aprobada");
          estado[materia.dataset.id] = false;
        }
      }
    });
  }

  actualizarBloqueos();

  // Guarda el estado actual en localStorage
  function guardarEstado() {
    localStorage.setItem("estadoMaterias", JSON.stringify(estado));
  }

  // Evento click para aprobar o desaprobar materia
  materias.forEach(materia => {
    materia.addEventListener("click", () => {
      const id = materia.dataset.id;

      // Si está bloqueada y no aprobada, no hacer nada
      if (materia.classList.contains("bloqueada") && !estado[id]) return;

      // Toggle estado aprobado
      estado[id] = !estado[id];
      materia.classList.toggle("aprobada", estado[id]);

      // Si desapruebas, actualizar bloqueos ya que puede afectar otras materias
      if (!estado[id]) {
        actualizarBloqueos();
      }

      guardarEstado();
    });
  });
});
